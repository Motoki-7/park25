<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8" />
	<link rel="stylesheet" href="/css/BaseAdmin.css">
	<link rel="stylesheet" href="/css/EditParking.css">
	<script type="text/javascript" th:src="@{/js/jquery-3.7.1.min.js}"></script>
	<script type="text/javascript" th:src="@{/js/utils.js}"></script>
	<script th:inline="javascript">
		$(document).ready(() => {
			const address1Value = /*[[${form.address1}]]*/ "";
			createAddress1Pulldown(address1Value);
			initBaseFeeRadioChange("[[${form.baseFeeRadio}]]");
			initOptionRadioChange("[[${form.optionRadio}]]");
			const dailyList = /*[[${form.dailyList}]]*/[];
			const baseFeeRadio = /*[[${form.baseFeeRadio}]]*/ "";
			if (dailyList && baseFeeRadio == 1) {
				dailyList.forEach(daily => addBaseFee(daily));
			}
		});
	</script>
</head>

<body>
	<!--ホームアイコン：全ページ共通-->
	<header>
		<a href="/HomeAdmin" class="header-link">
			<img src="/img/icon.png" alt="アイコン">
			<span class="header-title">ParkingLot / 管理者</span>
		</a>
	</header>

	<main>
		<div class="page-title">編集画面</div>

		<form id="editParkingform" method="post" th:action="@{/EditParking/put}" th:object="${form}">
			<input type="hidden" th:field="*{id}" />
			<input type="hidden" th:field="*{updateDate}" id="updateDate" />
			<div class="form-layout">
				<div class="form-input-block">
					<h2>駐車場情報</h2>
					<div class="form-row">
						<label for="id_address1">都道府県：</label>
						<select id="id_address1" name="address1" required>
							<option value="" disabled selected>プルダウン：都道府県選択</option>
						</select>
					</div>

					<div class="form-row">
						<label for="address2">市区町村：</label>
						<input th:field="*{address2}" id="address2" required />
					</div>

					<div class="form-row">
						<label for="address3">丁目：</label>
						<input th:field="*{address3}" id="address3"/>
					</div>

					<div class="form-row">
						<label for="name">駐車場名：</label>
						<input th:field="*{name}" id="name" required />
					</div>

					<div class="form-row">
						<label for="capacity">収容台数：</label>
						<input th:field="*{capacity}" id="capacity" type="text" pattern="^[0-9]+$"
							title="半角数字のみを入力してください" required />
					</div>
				</div>
				<div class="fee-option-block">
					<h2>駐車場料金</h2>
					<div class="fee-form-row">
						<label>
							<input type="radio" id="baseFeeRadioButton0" th:field="*{baseFeeRadio}" value="0" onclick="baseFeeRadioChange(this)">
							<span class="id_basefee0">終日固定</span>
						</label>
						<div class="id_basefee0">
							<input type="number" class="id_basefee0" th:field="*{amountDaily}" placeholder="終日固定料金"
								min="0" required>
							<span>円</span>
							<input type="number" class="id_basefee0" th:field="*{timeDailly}" placeholder="終日固定時間"
								min="0" required>
							<span>分</span>
						</div>
					</div>
					<div class="fee-form-row">
						<label>
							<input type="radio" th:field="*{baseFeeRadio}" value="1" onclick="baseFeeRadioChange(this)">
							<span class="id_basefee1">時間別</span>
						</label>
						<div class="id_basefee1" , id="baseFeeDiv">
							<button type="button" class="id_basefee1 full-width-btn"
								onclick="addBaseFee(index); index++;">追加</button>
							<div id="baseFee"></div>
						</div>
					</div>
					<div id="outputBaseFeeCheckboxesValidation" style="color: red;"></div>
					<div id="outputRangeValidationUsed" style="color: red;"></div>
					<div id="outputRangeValidationNotSet" style="color: red;"></div>
					<h2>オプション</h2>

					<div class="fee-form-row">
						<label>
							<input class="optionCheckbox" type="checkbox" th:field="*{optionRadio}" value="0"
								onclick="optionRadioChange(this)">
							<span class="id_option0">駐車後24時間最大</span>
						</label>
						<div class="id_option0 option-input-block">
							<input type="number" class="id_option0" th:field="*{maxRate24h}" placeholder="駐車後24時間最大"
								min="0" required>
							<span>円</span>
						</div>
					</div>
					<div class="fee-form-row">
						<label>
							<input class="optionCheckbox" type="checkbox" th:field="*{optionRadio}" value="1"
								onclick="optionRadioChange(this)">
							<span class="id_option1">当日最大</span>
						</label>
						<div class="id_option1 option-input-block">
							<input type="number" class="id_option1" th:field="*{maxRateDaily}" placeholder="当日最大"
								min="0" required>
							<span>円</span>
						</div>
					</div>
				</div>
			</div>
			<button type="button" id="submitBtn">更新</button>
		</form>

		<form>
			<button type="button" onclick="location.href='/HomeAdmin'">戻る</button>
		</form>

		<script>
			function setOptionInputs(value) {
				const id_input0List = document.querySelectorAll(".id_option0");
				const id_input1List = document.querySelectorAll(".id_option1");
				const allInputs = [...id_input0List, ...id_input1List];

				// 一旦全て無効化
				allInputs.forEach(input => {
					input.disabled = true;
					input.style.opacity = 0.5;
				});

				// 指定のvalueに該当するクラスを有効化
				if (value === "0") {
					id_input0List.forEach(input => {
						input.disabled = false;
						input.style.opacity = 1;
					});
				} else if (value === "1") {
					id_input1List.forEach(input => {
						input.disabled = false;
						input.style.opacity = 1;
					});
				}
			}

			function optionRadioChange(selected) {
				const checkboxes = document.querySelectorAll(".optionCheckbox");
				if (!selected.checked) {
					// チェック外れた場合は全部無効化
					setOptionInputs(null);
					return;
				}
				// 他のチェックボックスはoff
				checkboxes.forEach(cb => {
					if (cb !== selected) cb.checked = false;
				});
				setOptionInputs(selected.value);
			}

			function initOptionRadioChange(selectedValue) {
				const checkboxes = document.querySelectorAll(".optionCheckbox");
				checkboxes.forEach(cb => {
					cb.checked = (cb.value === selectedValue);
				});
				setOptionInputs(selectedValue);
			}
			function initBaseFeeRadioChange(selected) {
				const id_basefee0List = document.querySelectorAll(".id_basefee0");
				const id_basefee1List = document.querySelectorAll(".id_basefee1");
				const allInputs = [
					...id_basefee0List,
					...id_basefee1List,
				];
				allInputs.forEach(input => {
					input.disabled = true;
					input.style.opacity = 0.5;
				});
				if (selected === "0") {
					id_basefee0List.forEach(input => {
						input.disabled = false;
						input.style.opacity = 1;
					});
				} else if (selected === "1") {
					id_basefee1List.forEach(input => {
						input.disabled = false;
						input.style.opacity = 1;
					});
				}
			}
		</script>
		<script>
			function baseFeeRadioChange(selected) {
				const id_basefee0List = document.querySelectorAll(".id_basefee0");
				const id_basefee1List = document.querySelectorAll(".id_basefee1");
				const allInputs = [
					...id_basefee0List,
					...id_basefee1List,
				];
				allInputs.forEach(input => {
					input.disabled = true;
					input.style.opacity = 0.5;
				});
				if (selected.value === "0") {
					id_basefee0List.forEach(input => {
						input.disabled = false;
						input.style.opacity = 1;
					});
				} else if (selected.value === "1") {
					id_basefee1List.forEach(input => {
						input.disabled = false;
						input.style.opacity = 1;
					});
				}
			}
		</script>
		<script>
			var index = 0;
			function addBaseFee(daily = {}) {
				const $list = $(`
							      <div class="baseFeeBlock">
									<input type="hidden" name="dailyList[${index}].ratesId" value="${daily.ratesId || ''}" />
									<input type="hidden" name="dailyList[${index}].rangeId" value="${daily.rangeId || ''}" />
							        <table>
							          <tr>
										<th></th>
							            <th>月曜</th>
							            <th>火曜</th>
							            <th>水曜</th>
							            <th>木曜</th>
							            <th>金曜</th>
							            <th>土曜</th>
							            <th>日曜</th>
							            <th>祝日</th>
										<th></th>
							          </tr>
									  <tr>
										<td><input class="id_basefee1 allCheck" type="checkbox"></td>
									    <td><input class="id_basefee1" type="checkbox" name="dailyList[${index}].monday" value="true" ${daily.monday ? 'checked' : ''}></td>
									    <td><input class="id_basefee1" type="checkbox" name="dailyList[${index}].tuesday" value="true" ${daily.tuesday ? 'checked' : ''}></td>
									    <td><input class="id_basefee1" type="checkbox" name="dailyList[${index}].wednesday" value="true" ${daily.wednesday ? 'checked' : ''}></td>
									    <td><input class="id_basefee1" type="checkbox" name="dailyList[${index}].thursday" value="true" ${daily.thursday ? 'checked' : ''}></td>
									    <td><input class="id_basefee1" type="checkbox" name="dailyList[${index}].friday" value="true" ${daily.friday ? 'checked' : ''}></td>
									    <td><input class="id_basefee1" type="checkbox" name="dailyList[${index}].saturday" value="true" ${daily.saturday ? 'checked' : ''}></td>
									    <td><input class="id_basefee1" type="checkbox" name="dailyList[${index}].sunday" value="true" ${daily.sunday ? 'checked' : ''}></td>
									    <td><input class="id_basefee1" type="checkbox" name="dailyList[${index}].holiday" value="true" ${daily.holiday ? 'checked' : ''}></td>
									    <td><button type="button" class="deleteBaseFeeBtn">削除</button></td>
									  </tr>
							        </table><br>
							        <div>
										<div class="time_selecter">
											<span>開始時刻:</span>
											<select class="hour-select" name="dailyList[${index}].startTime"></select>
											<span>時</span>
											<span>　終了時刻:</span>
											<select class="hour-select" name="dailyList[${index}].endTime"></select>
											<span>時</span>
										</div>
										<div class="fee-input-row">
								          <input type="number" class="id_basefee1" name="dailyList[${index}].time" value="${daily.time || ''}" min="0" required>
								          <span>分</span>
								          <input type="number" class="id_basefee1" name="dailyList[${index}].amount" value="${daily.amount || ''}"  min="0" required>
								          <span>円</span>
										  <span>最大</span>
								          <input type="number" class="id_basefee1" name="dailyList[${index}].maxRateTimely" value="${daily.maxRateTimely || ''}" min="0">
										  <span>円</span>
							        	</div>
									</div>
							      </div>
							    `);
				// 時間セレクトボックスにオプション追加
				$list.find(".hour-select").each(function () {
					for (let i = 0; i <= 23; i++) {
						$(this).append(`<option value="${i}">${i}</option>`);
					}
				});
				$list.find("select[name='dailyList[" + index + "].startTime']").val(daily.startTime ?? "0");
				$list.find("select[name='dailyList[" + index + "].endTime']").val(daily.endTime ?? "0");
				
				// 削除ボタンにイベントを追加
				$list.find(".deleteBaseFeeBtn").on("click", function () {
					$(this).closest(".baseFeeBlock").remove();
					reindexBaseFeeBlocks();
				});
				// 全選択ボタンにイベントを追加
				$list.find(".allCheck").on("click", function() {
					const isChecked = $(this).is(":checked");

					// 同じ baseFeeBlock 内の、dailyList で始まるチェックボックスをすべて取得
					$(this)
						.closest(".baseFeeBlock")
						.find('input[type="checkbox"]')
						.filter(function () {
							return $(this).attr("name")?.startsWith("dailyList");
						})
						.prop("checked", isChecked);
				});
				$("#baseFee").append($list);
				index++;
				reindexBaseFeeBlocks();
				function reindexBaseFeeBlocks() {
					const blocks = document.querySelectorAll(".baseFeeBlock");
					blocks.forEach((block, newIndex) => {
						block.querySelectorAll("input, select").forEach(el => {
							if (el.name) {
								el.name = el.name.replace(/dailyList\[\d+\]/, `dailyList[${newIndex}]`);
							}
						});
					});
				}
			}
		</script>


		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const form = document.getElementById("editParkingform");

				const today = new Date().toISOString().split('T')[0];
				document.getElementById("updateDate").value = today;


				document.getElementById("submitBtn").addEventListener("click", function () {
					if (!form.checkValidity()) {
						form.reportValidity(); // ← ここでブラウザの警告（吹き出し）が出る
						return;
					}
					let boolValidation = true;
					if (!baseFeeCheckboxesValidation()) {
						boolValidation = false;
					}
					if (!rangeValidation()) {
						boolValidation = false;
					}
					if (!boolValidation) {
						return;
					}
					const capacity = document.getElementById("capacity").value.trim();



					let isValid = true;
					let errorMessage = "";

					// capacity：1以上の整数
					if (!/^[1-9][0-9]*$/.test(capacity)) {
						errorMessage += "収容台数は1以上の数値で入力してください。\n";
						isValid = false;
					}

					if (!isValid) {
						alert(errorMessage);
						return;
					}

					const address1 = document.getElementById("id_address1").value;
					const address2 = document.getElementById("address2").value;
					const address3 = document.getElementById("address3").value;
					const name = document.getElementById("name").value;

					const message = `この内容で登録しますか？\n\n県名: ${address1}\n市町村: ${address2}\n丁目: ${address3}\n駐車場名: ${name}\n収容台数: ${capacity}\n`;

					const result = confirm(message);
					if (result) {
						document.getElementById("editParkingform").requestSubmit();
					}
				});
			});

		</script>
		<script>
			function rangeValidation() {
				const isSelected = document.getElementById("baseFeeRadioButton0").checked;
				if (isSelected) {
				    return true;
				}
				const rows = document.getElementsByClassName("baseFeeBlock");
				let array724 = [];
				for (let i = 0; i < 7; i++) {
					const row = [];
					for (let j = 0; j < 24; j++) {
						row.push(false);
					}
					array724.push(row);
				}
				let array724error = [];
				for (let i = 0; i < 7; i++) {
					const row = [];
					for (let j = 0; j < 24; j++) {
						row.push(false);
					}
					array724error.push(row);
				}
				const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];
				const daysJ = ["月曜", "火曜", "水曜", "木曜", "金曜", "土曜", "日曜"];
				for (let i = 0; i < rows.length; i++) {
					const row = rows[i];
					const startTime = row.querySelector('select[name$=".startTime"]');
					const endTime = row.querySelector('select[name$=".endTime"]');
					let startTimeValue = Number(startTime?.value);
					let endTimeValue = Number(endTime?.value);
					if (startTimeValue >= endTimeValue) {
						endTimeValue += 24;
					}
					days.forEach((day, dayIndex) => {
						const checkbox = row.querySelector(`input[name$=".${day}"]`);
						if (checkbox?.checked) {
							for (let j = startTimeValue; j < endTimeValue; j++) {
								if (j < 24) {
									if (array724[dayIndex][j]) {
										array724error[dayIndex][j] = true;
									} else {
										array724[dayIndex][j] = true;
									}
								} else {
									let dayIndexbuf = dayIndex + 1;
									if (dayIndexbuf > 6) {
										dayIndexbuf = 0;
									}
									if (array724[dayIndexbuf][j - 24]) {
										array724error[dayIndexbuf][j - 24] = true;
									} else {
										array724[dayIndexbuf][j - 24] = true;
									}
								}
							}
						}
					});
				}
				let result = [];
				daysJ.forEach((day, dayIndex) => {
					let start = null;
					for (let i = 0; i < array724error[dayIndex].length; i++) {
						if (array724error[dayIndex][i]) {
							if (start === null) {
								start = i;
							}
						} else {
							if (start !== null) {
								result.push(`${day} ${start}時から${i}時`);
								start = null;
							}
						}
					}

					// 最後が true で終わる場合の処理
					if (start !== null) {
						result.push(`${day} ${start}時から${array724error[dayIndex].length - 24}時`);
					}
				});
				if (result.length !== 0) {
					result.unshift(`期間が重複しています。`);
				}

				let result2 = [];
				daysJ.forEach((day, dayIndex) => {
					let start = null;
					for (let i = 0; i < array724[dayIndex].length; i++) {
						if (!array724[dayIndex][i]) {
							if (start === null) {
								start = i;
							}
						} else {
							if (start !== null) {
								result2.push(`${day} ${start}時から${i}時`);
								start = null;
							}
						}
					}

					// 最後が true で終わる場合の処理
					if (start !== null) {
						result2.push(`${day} ${start}時から${array724[dayIndex].length - 24}時`);
					}
				});
				if (result2.length !== 0) {
					result2.unshift(`未設定の期間があります。`);
				}
				const outputDivUsed = document.getElementById("outputRangeValidationUsed");
				const outputDivNotSet = document.getElementById("outputRangeValidationNotSet");
				outputDivUsed.innerHTML = result.map(line => `<div>${line}</div>`).join("");
				outputDivNotSet.innerHTML = result2.map(line => `<div>${line}</div>`).join("");
				if (result.length == 0 && result2.length == 0) {
					return true;
				}
				return false;
			}

			function baseFeeCheckboxesValidation() {
				const isSelected = document.getElementById("baseFeeRadioButton0").checked;
				if (isSelected) {
				    return true;
				}
				const blocks = document.querySelectorAll(".baseFeeBlock");
				let isValid = true;
				$('#outputBaseFeeCheckboxesValidation').text("");

				for (const block of blocks) {
					const checkboxes = block.querySelectorAll('input[type="checkbox"]');

					// allCheck クラス以外のチェックボックスだけを見る
					const targetCheckboxes = Array.from(checkboxes).filter(cb => !cb.classList.contains("allCheck"));

					const isChecked = targetCheckboxes.some(cb => cb.checked);

					if (!isChecked) {
						$('#outputBaseFeeCheckboxesValidation').text("曜日が設定されていない項目があります。");
						isValid = false;
						break;
					}
				}

				return isValid;
			}
		</script>
	</main>
</body>

</html>