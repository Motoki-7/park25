<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>

	<meta charset="utf-8" />
	<link rel="stylesheet" href="/css/BaseAdmin.css">
	<link rel="stylesheet" href="/css/RegistParking2.css">
	<script type="text/javascript" th:src="@{/js/jquery-3.7.1.min.js}"></script>
	<script type="text/javascript" th:src="@{/js/utils.js}"></script>
	<script type="text/javascript" th:src="@{/js/RegistParking.js}"></script>
	<script>
		var index = 0;
		$(document).ready(() => {
			initBaseFeeRadioChange("[[${form.baseFeeRadio}]]");
			initOptionRadioChange("[[${form.optionRadio}]]");
		});
	</script>
</head>

<body>
	<!--ホームアイコン：全ページ共通-->
	<header>
		<a href="/HomeAdmin" class="header-link">
			<img src="/img/icon.png" alt="アイコン">
			<span class="header-title">ParkingLot / 管理者</span>
		</a>
	</header>

	<main>
		<!-- ヘッダー直下に画面タイトルを追加 -->
		<div class="page-title">新規登録画面</div>

		<form id="registParkingform" method="post" th:action="@{/RegistParking/post}" th:object="${form}">
			<input type="hidden" th:field="*{updateDate}" id="updateDate" />
			<div class="form-layout">
				<div class="form-input-block">
					<h2>駐車場情報</h2>
					<div class="form-row">
						<label for="id_address1">都道府県：</label>
						<select id="id_address1" name="address1" required>
							<option value="" disabled selected>プルダウン：都道府県選択</option>
						</select>
					</div>

					<div class="form-row">
						<label for="address2">市区町村：</label>
						<input th:field="*{address2}" id="address2" required />
					</div>

					<div class="form-row">
						<label for="address3">丁目：</label>
						<input th:field="*{address3}" id="address3" required />
					</div>

					<div class="form-row">
						<label for="name">駐車場名：</label>
						<input th:field="*{name}" id="name" required />
					</div>

					<div class="form-row">
						<label for="capacity">収容台数：</label>
						<input th:field="*{capacity}" id="capacity" type="text" pattern="^[0-9]+$"
							title="半角数字のみを入力してください" required />
					</div>

					<div class="form-row">
						<label for="hourlyRate">1時間当たりの料金：</label>
						<input th:field="*{hourlyRate}" id="hourlyRate" type="text" pattern="^[0-9]+$"
							title="半角数字のみを入力してください" required />
					</div>
				</div>
				<div class="fee-option-block">
					<h2>駐車場料金</h2>
					<div class="fee-form-row">
						<label>
							<input type="radio" th:field="*{baseFeeRadio}" value="0" onclick="baseFeeRadioChange(this)">
							<span class="id_basefee0">終日固定</span>
						</label>
						<div class="id_basefee0">
							<input type="number" class="id_basefee0" th:field="*{amountDaily}" placeholder="終日固定料金"
								min="0" required>
							<span>円</span>
							<input type="number" class="id_basefee0" th:field="*{timeDailly}" placeholder="終日固定時間"
								min="0" required>
							<span>分</span>
						</div>
					</div>
					<div class="fee-form-row">
						<label>
							<input type="radio" th:field="*{baseFeeRadio}" value="1" onclick="baseFeeRadioChange(this)">
							<span class="id_basefee1">時間別</span>
						</label>
						<div class="id_basefee1" , id="baseFeeDiv">
							<button type="button" class="id_basefee1 full-width-btn"
								onclick="addBaseFee(index); index++;">追加</button>
							<div id="baseFee"></div>
						</div>
					</div>
					<div id="outputBaseFeeCheckboxesValidation" style="color: red;"></div>
					<div id="outputRangeValidationUsed" style="color: red;"></div>
					<div id="outputRangeValidationNotSet" style="color: red;"></div>
					<h2>オプション</h2>

					<div class="fee-form-row">
						<label>
							<input class="optionCheckbox" type="checkbox" th:field="*{optionRadio}" value="0"
								onclick="optionRadioChange(this)">
							<span class="id_option0">駐車後24時間最大</span>
						</label>
						<div class="id_option0 option-input-block">
							<input type="number" class="id_option0" th:field="*{maxRate24h}" placeholder="駐車後24時間最大"
								min="0" required>
							<span>円</span>
						</div>
					</div>
					<div class="fee-form-row">
						<label>
							<input class="optionCheckbox" type="checkbox" th:field="*{optionRadio}" value="1"
								onclick="optionRadioChange(this)">
							<span class="id_option1">当日最大</span>
						</label>
						<div class="id_option1 option-input-block">
							<input type="number" class="id_option1" th:field="*{maxRateDaily}" placeholder="当日最大"
								min="0" required>
							<span>円</span>
						</div>
					</div>
				</div>
			</div>
			<button type="button" id="submitBtn">登録</button>
		</form>


		<form>
			<button type="button" onclick="location.href='/HomeAdmin'">戻る</button>
		</form>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const form = document.getElementById("registParkingform");

				const today = new Date().toISOString().split('T')[0];
				document.getElementById("updateDate").value = today;

				document.getElementById("submitBtn").addEventListener("click", function () {
					if (!form.checkValidity()) {
						form.reportValidity(); // ← ここでブラウザの警告（吹き出し）が出る
						return;
					}
					let boolValidation = true;
					if (!baseFeeCheckboxesValidation()) {
						boolValidation = false;
					}
					if (!rangeValidation()) {
						boolValidation = false;
					}
					if (!boolValidation) {
						return;
					}
					const capacity = document.getElementById("capacity").value.trim();
					const hourlyRate = document.getElementById("hourlyRate").value.trim();

					let isValid = true;
					let errorMessage = "";

					// capacity：1以上の整数
					if (!/^[1-9][0-9]*$/.test(capacity)) {
						errorMessage += "収容台数は1以上の数値で入力してください。\n";
						isValid = false;
					}

					// hourlyRate：0以上の数値（整数 or 小数）
					if (!/^(0|[1-9]\d*)(\.\d+)?$/.test(hourlyRate)) {
						errorMessage += "1時間当たりの料金は0以上の数値で入力してください。\n";
						isValid = false;
					}

					if (!isValid) {
						alert(errorMessage);
						return;
					}




					const address1 = document.getElementById("id_address1").value;
					const address2 = document.getElementById("address2").value;
					const address3 = document.getElementById("address3").value;
					const name = document.getElementById("name").value;

					const message = `この内容で登録しますか？\n\n県名: ${address1}\n市町村: ${address2}\n丁目: ${address3}\n駐車場名: ${name}\n収容台数: ${capacity}\n１時間当たりの料金: ${hourlyRate}`;

					const result = confirm(message);
					if (result) {
						document.getElementById("registParkingform").requestSubmit();
					}
				});
			});

		</script>
	</main>
</body>

</html>