<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:with="form=${form}">

<head>
	<meta charset="UTF-8">
	<title>Parking Detail Map</title>
	<!-- Thymeleaf のコンテキストパスを考慮した絶対パス指定 -->
	<link rel="stylesheet" th:href="@{/css/BaseUser.css}">
	<link rel="stylesheet" th:href="@{/css/ParkingDetail.css}">
	<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
	<script type="text/javascript" th:src="@{/js/jquery-3.7.1.min.js}"></script>
	<script>
		$(document).ready(() => {
			$('#id_calc').click(() => {
				feeCalculation();
			});
		});
	</script>
</head>

<body>
	<!--ホームアイコン：全ページ共通-->
	<header>
		<a href="/" class="header-link">
			<img src="/img/icon.png" alt="アイコン">
			<span class="header-title">ParkingLot</span>
		</a>
	</header>

	<main>
		<div class="page-title">詳細情報</div>

		<!-- 3. 情報と地図を横並びにするラッパー -->
		<div class="detail-container">
			<div class="detail-info">
				<div>住所：<span th:text="${form.address1} + ${form.address2} + ${form.address3}"></span></div>
				<div>駐車場名：<span th:text="${form.name}"></span></div>
				<div>収容台数：<span th:text="${form.capacity}"></span>台</div>
				<div>１時間当たりの料金：<span th:text="${form.hourlyRate}"></span>円</div>
			</div>
			<div>
				<table>
					<tr>
						<td>
							<label>入庫時刻</label>
						</td>
						<td>
							<input type="date" id="id_entryDate" name="date" required>
							<input type="time" id="id_entryTime" name="time" required>
						</td>
					</tr>
					<tr>
						<td>
							<label>出庫時刻</label>
						</td>
						<td>
							<input type="date" id="id_exitDate" name="date" required>
							<input type="time" id="id_exitTime" name="time" required>
						</td>
					</tr>
				</table>
				<div id="id_calcResult"></div>
				<div id="id_errorMsg" style="color: red;"></div>
				<input type="button" id="id_calc" value="計算">
			</div>
			<div id="map"></div>
		</div>

		<!-- 1. 戻るボタンの追加 -->
		<form th:action="@{/}">
			<button type="submit">戻る</button>
		</form>
		<!-- Thymeleaf で form を JS に渡す -->
		<script th:inline="javascript">
			/*<![CDATA[*/
			const form = /*[[${form}]]*/ {};
			/*]]>*/
		</script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
		<script th:src="@{/js/ParkingDetail.js}"></script>
		<script th:inline="javascript">
			function feeCalculation() {
				let parkinglotId = /*[[${form.id}]]*/ "";
				console.log(parkinglotId);
				let id_entryDate = $('#id_entryDate').val();
				let id_entryTime = $('#id_entryTime').val();
				let id_exitDate = $('#id_exitDate').val();
				let id_exitTime = $('#id_exitTime').val();
				if (id_entryDate != "" && id_entryTime != "" && id_exitDate != "" && id_exitTime != "") {
					$('#id_errorMsg').text("");
					var url = "/aaa?";
					url += "id=" + parkinglotId;
					url += "entryDate=" + id_entryDate;
					url += "&entryTime=" + id_entryTime;
					url += "&exitDate=" + id_exitDate;
					url += "&exitTime=" + id_exitTime;
					fetch(url)
						.then((response) => {
							if (!response.ok) throw new Error(`通信エラー: ${response.status}`);
							return response.json();
						})
						.then((result) => {
							console.log(result);
							$('#id_errorMsg').text(result);
						})
						.catch((error) => {
							throw new Error("Get失敗");
						});
				} else {
					$('#id_errorMsg').text("値を入力してください");
				}
			}
		</script>
	</main>
</body>

</html>